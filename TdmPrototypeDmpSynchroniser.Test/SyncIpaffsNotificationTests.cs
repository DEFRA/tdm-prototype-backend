using FluentAssertions;
using System.Reflection;
using System.Text.Json.Serialization;
using System.Text.Json;
using TdmPrototypeBackend.Types;
using TdmPrototypeDmpSynchroniser.Api.Models;
using static TdmPrototypeDmpSynchroniser.Api.Models.Test.SyncIpaffsNotificationTests;

namespace TdmPrototypeDmpSynchroniser.Api.Models.Test;

public class SyncIpaffsNotificationTests
{
    [Fact]
    public void ShouldDeserialise()
    {
        var s =
            "{\n    \"id\": 36543,\n    \"referenceNumber\": \"CHEDP.GB.2024.1036543\",\n    \"version\": 1,\n    \"lastUpdated\": \"2024-09-12T12:13:47.923Z\",\n    \"lastUpdatedBy\": {\n        \"displayName\": \"Mark Admin-Tester\",\n        \"userId\": \"79f6dc68-2144-e911-a96a-000d3a29ba60\"\n    },\n    \"type\": \"CVEDP\",\n    \"status\": \"SUBMITTED\",\n    \"riskAssessment\": {\n        \"commodityResults\": [\n            {\n                \"riskDecision\": \"REQUIRED\",\n                \"uniqueId\": \"49431dfe-bc23-4fb4-aa78-ad6fd8388350\"\n            }\n        ],\n        \"assessmentDateTime\": \"2024-09-12T13:13:47.894361934\"\n    },\n    \"journeyRiskCategorisation\": {\n        \"riskLevel\": \"Low\",\n        \"riskLevelMethod\": \"User\",\n        \"riskLevelDateTime\": \"2024-09-12T12:12:18.627\"\n    },\n    \"isHighRiskEuImport\": false,\n    \"partOne\": {\n        \"personResponsible\": {\n            \"name\": \"Mark Admin-Tester\",\n            \"companyId\": \"767ceb6a-2144-e911-a96c-000d3a29b5de\",\n            \"companyName\": \"Defra Test BIP\",\n            \"address\": [\n                \"Animal and Plant Health Agency\",\n                \"Woodham Lane\",\n                \"New Haw\",\n                \"Surrey\",\n                \"Addlestone\",\n                \"KT15 3NB\"\n            ],\n            \"country\": \"GB\",\n            \"tracesID\": 1001,\n            \"phone\": \"020 8225 7295\",\n            \"email\": \"DefraTestBIP@anthunt3.33mail.com\",\n            \"contactId\": \"79f6dc68-2144-e911-a96a-000d3a29ba60\"\n        },\n        \"consignor\": {\n            \"id\": \"2ab17df9-e875-4bb9-a5e9-4c9ce6c5695c\",\n            \"type\": \"exporter\",\n            \"status\": \"nonapproved\",\n            \"companyName\": \"f10888e8744d402c963c13352b53e736\",\n            \"address\": {\n                \"addressLine1\": \"53096 Murphy Station\",\n                \"addressLine2\": \"Suite 555\",\n                \"addressLine3\": \"Kansas\",\n                \"city\": \"South Ryleyview\",\n                \"postalZipCode\": \"12674\",\n                \"countryISOCode\": \"PL\",\n                \"telephone\": \"01615555555\",\n                \"email\": \"ukoperator@email.com\"\n            },\n            \"tracesId\": 10005792\n        },\n        \"consignee\": {\n            \"id\": \"6d8f4fa7-594a-462f-9008-9a39276225ea\",\n            \"type\": \"consignee\",\n            \"status\": \"nonapproved\",\n            \"companyName\": \"4b1a8571489f43368438ffe5c148fc2a\",\n            \"address\": {\n                \"addressLine1\": \"610 Arthur Roads\",\n                \"addressLine2\": \"Suite 843\",\n                \"addressLine3\": \"Maryland\",\n                \"city\": \"Port Alvinaside\",\n                \"postalZipCode\": \"91444\",\n                \"countryISOCode\": \"GB\",\n                \"telephone\": \"01615555555\",\n                \"email\": \"ukoperator@email.com\"\n            },\n            \"tracesId\": 10008612\n        },\n        \"importer\": {\n            \"id\": \"6d8f4fa7-594a-462f-9008-9a39276225ea\",\n            \"type\": \"importer\",\n            \"status\": \"nonapproved\",\n            \"companyName\": \"4b1a8571489f43368438ffe5c148fc2a\",\n            \"address\": {\n                \"addressLine1\": \"610 Arthur Roads\",\n                \"addressLine2\": \"Suite 843\",\n                \"addressLine3\": \"Maryland\",\n                \"city\": \"Port Alvinaside\",\n                \"postalZipCode\": \"91444\",\n                \"countryISOCode\": \"GB\",\n                \"telephone\": \"01615555555\",\n                \"email\": \"ukoperator@email.com\"\n            },\n            \"tracesId\": 10008612\n        },\n        \"placeOfDestination\": {\n            \"id\": \"6d8f4fa7-594a-462f-9008-9a39276225ea\",\n            \"type\": \"destination\",\n            \"status\": \"nonapproved\",\n            \"companyName\": \"4b1a8571489f43368438ffe5c148fc2a\",\n            \"address\": {\n                \"addressLine1\": \"610 Arthur Roads\",\n                \"addressLine2\": \"Suite 843\",\n                \"addressLine3\": \"Maryland\",\n                \"city\": \"Port Alvinaside\",\n                \"postalZipCode\": \"91444\",\n                \"countryISOCode\": \"GB\",\n                \"telephone\": \"01615555555\",\n                \"email\": \"ukoperator@email.com\"\n            },\n            \"tracesId\": 10008612\n        },\n        \"commodities\": {\n            \"totalGrossWeight\": 3,\n            \"totalNetWeight\": 1,\n            \"numberOfPackages\": 1,\n            \"temperature\": \"Ambient\",\n            \"commodityComplement\": [\n                {\n                    \"commodityID\": \"0401\",\n                    \"commodityDescription\": \"Milk and cream, not concentrated nor containing added sugar or other sweetening matter\",\n                    \"complementID\": 1,\n                    \"complementName\": \"Camelus dromedarius\",\n                    \"speciesID\": \"106568\",\n                    \"speciesName\": \"Camelus dromedarius\",\n                    \"speciesTypeName\": \"Raw milk\",\n                    \"speciesType\": \"49\",\n                    \"speciesClass\": \"167425\",\n                    \"speciesNomination\": \"Camelus dromedarius\"\n                }\n            ],\n            \"complementParameterSet\": [\n                {\n                    \"uniqueComplementID\": \"49431dfe-bc23-4fb4-aa78-ad6fd8388350\",\n                    \"complementID\": 1,\n                    \"speciesID\": \"106568\",\n                    \"keyDataPair\": [\n                        {\n                            \"key\": \"netweight\",\n                            \"data\": \"1\"\n                        },\n                        {\n                            \"key\": \"number_package\",\n                            \"data\": \"1\"\n                        },\n                        {\n                            \"key\": \"type_package\",\n                            \"data\": \"Bale\"\n                        }\n                    ]\n                }\n            ],\n            \"includeNonAblactedAnimals\": false,\n            \"countryOfOrigin\": \"AF\",\n            \"consignedCountry\": \"AF\"\n        },\n        \"purpose\": {\n            \"conformsToEU\": true,\n            \"internalMarketPurpose\": \"Human Consumption\",\n            \"purposeGroup\": \"For Import\"\n        },\n        \"pointOfEntry\": \"GBMNC1\",\n        \"arrivalDate\": \"2024-09-13\",\n        \"arrivalTime\": \"10:00:00\",\n        \"transporterDetailsRequired\": false,\n        \"meansOfTransport\": {},\n        \"meansOfTransportFromEntryPoint\": {\n            \"id\": \"afssd\",\n            \"type\": \"Aeroplane\",\n            \"document\": \"kdfksdl\"\n        },\n        \"veterinaryInformation\": {},\n        \"submissionDate\": \"2024-09-12T12:13:46.307030992Z\",\n        \"submittedBy\": {\n            \"displayName\": \"Mark Admin-Tester\",\n            \"userId\": \"79f6dc68-2144-e911-a96a-000d3a29ba60\"\n        },\n        \"complexCommoditySelected\": true,\n        \"portOfEntry\": \"GBMAN\",\n        \"contactDetails\": {\n            \"name\": \"Mark Admin-Tester\",\n            \"telephone\": \"020 8225 7295\",\n            \"email\": \"defratestbip@anthunt3.33mail.com\"\n        },\n        \"isGVMSRoute\": false,\n        \"provideCtcMrn\": \"NO\"\n    },\n    \"partTwo\": {\n        \"decision\": {\n            \"decision\": \"Acceptable for Internal Market\",\n            \"freeCirculationPurpose\": \"Human Consumption\"\n        },\n        \"consignmentCheck\": {},\n        \"consignmentValidation\": [\n            {\n                \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/parttwo/decision/consignmentacceptable\",\n                \"message\": \"What is the decision for this consignment\"\n            },\n            {\n                \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/parttwo/consignmentcheck/physicalcheckdone\",\n                \"message\": \"Physical check\"\n            },\n            {\n                \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/parttwo/consignmentcheck/documentcheckresult\",\n                \"message\": \"Documentary check\"\n            },\n            {\n                \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/parttwo/laboratorytestsrequired\",\n                \"message\": \"Are laboratory tests required\"\n            },\n            {\n                \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/parttwo/consignmentcheck/identitycheckdone\",\n                \"message\": \"Identity check\"\n            },\n            {\n                \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/partone/veterinaryinformation/establishmentsoforigin\",\n                \"message\": \"Approved establishment\"\n            }\n        ],\n        \"inspectionRequired\": \"Required\"\n    },\n    \"partThree\": {\n        \"sealCheckRequired\": false\n    },\n    \"consignmentValidation\": [\n        {\n            \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/notification/parttwo/consignmentcheck/documentcheckresult\",\n            \"message\": \"Documentary check\"\n        },\n        {\n            \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/notification/parttwo/consignmentcheck/identitycheckdone\",\n            \"message\": \"Identity check\"\n        },\n        {\n            \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/notification/parttwo/consignmentcheck/physicalcheckdone\",\n            \"message\": \"Physical check\"\n        },\n        {\n            \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/notification/parttwo/laboratorytestsrequired\",\n            \"message\": \"Are laboratory tests required\"\n        },\n        {\n            \"field\": \"uk/gov/defra/tracesx/notificationschema/representation/notification/parttwo/decision/consignmentacceptable\",\n            \"message\": \"What is the decision for this consignment\"\n        }\n    ],\n    \"etag\": \"0000000000083ED7\",\n    \"riskDecisionLockingTime\": \"2024-09-13T07:00:00Z\",\n    \"isRiskDecisionLocked\": false,\n    \"chedTypeVersion\": 1\n}";

        var n = IpaffsNotificationExtensions.FromBlob(s);

      


        // Unique ID should be set - need to check where the 'movement ID' is stored on the ALVS message 
        // n.Id.Should().Be("CHEDP.GB.2024.1036543");
        //n.IpaffsId.Should().Be(36543);
        n.PartOne.Commodities.CountryOfOrigin.Should().Be("AF");
        // m.Items.Length.Should().Be(2);
        // m.ClearanceRequests.Length.Should().Be(1);
        //
        // // Corrects case
        // m.ClearanceRequests.First().Header.SubmitterTurn.Should().Be("SubmitterTurn051399d7-da2e-49dc-842c-236a4e84566d");
        //     
        // // epoch parsing
        // m.ClearanceRequests.First().ServiceHeader.ServiceCallTimestamp.Should().Be(new DateTime(2024, 8, 8, 14, 39, 27));
        //
        // // Datetime parsing
        // m.ClearanceRequests.First().Header.ArrivalDateTime.Should().Be(new DateTime(2024, 8, 8, 16, 39, 27));

    }

    [Fact]
    public void ShouldDeserialise1()
    {

        var s =
            "{\r\n   \"id\":0,\r\n   \"referenceNumber\":\"CHEDP.GB.2024.1360375\",\r\n   \"externalReferences\":[\r\n      {\r\n         \"system\":\"NCTS\",\r\n         \"reference\":\"24GB1549311549315\",\r\n         \"exactMatch\":true,\r\n         \"verifiedByImporter\":true,\r\n         \"verifiedByInspector\":false\r\n      }\r\n   ],\r\n   \"version\":1,\r\n   \"lastUpdated\":\"2024-09-04T10:22:56.6442175+00:00\",\r\n   \"lastUpdatedBy\":{\r\n      \"displayName\":\"Percy Inspector-Tester\",\r\n      \"userId\":\"79f6dc68-2144-e911-a96a-000d3a29ba60\",\r\n      \"isControlUser\":true\r\n   },\r\n   \"type\":\"CVEDP\",\r\n   \"status\":\"IN_PROGRESS\",\r\n   \"isHighRiskEuImport\":false,\r\n   \"partOne\":{\r\n      \"personResponsible\":null,\r\n      \"containsWoodPackaging\":false,\r\n      \"consignor\":null,\r\n      \"consignee\":null,\r\n      \"importer\":null,\r\n      \"placeOfDestination\":null,\r\n      \"commodities\":{\r\n         \"totalGrossWeight\":1,\r\n         \"totalNetWeight\":0,\r\n         \"numberOfPackages\":12,\r\n         \"temperature\":null,\r\n         \"numberOfAnimals\":61,\r\n         \"commodityComplement\":[\r\n            {\r\n               \"commodityID\":\"621088026\",\r\n               \"complementID\":1911,\r\n               \"complementName\":null,\r\n               \"eppoCode\":null,\r\n               \"commodityDescription\":null,\r\n               \"speciesID\":\"3144\",\r\n               \"speciesName\":\"Sus scrofa domesticus\",\r\n               \"speciesTypeName\":\"Domestic\",\r\n               \"speciesType\":\"1911\",\r\n               \"speciesClass\":\"1911\",\r\n               \"speciesFamily\":\"1911\",\r\n               \"speciesNomination\":\"Sus scrofa domesticus\"\r\n            }\r\n         ],\r\n         \"complementParameterSet\":[\r\n            {\r\n               \"uniqueComplementId\":null,\r\n               \"complementID\":1911,\r\n               \"speciesID\":\"3144\",\r\n               \"keyDataPair\":[\r\n                  {\r\n                     \"key\":\"number_package\",\r\n                     \"data\":\"12\"\r\n                  },\r\n                  {\r\n                     \"key\":\"number_animal\",\r\n                     \"data\":\"61\"\r\n                  },\r\n                  {\r\n                     \"key\":\"invasive_specie\",\r\n                     \"data\":\"false\"\r\n                  },\r\n                  {\r\n                     \"key\":\"allowed\",\r\n                     \"data\":\"false\"\r\n                  }\r\n               ]\r\n            }\r\n         ],\r\n         \"includeNonAblactedAnimals\":false,\r\n         \"countryOfOrigin\":null,\r\n         \"countryOfOriginIsPodCountry\":false,\r\n         \"isLowRiskArticle72Country\":false,\r\n         \"regionOfOrigin\":null,\r\n         \"consignedCountry\":null,\r\n         \"consignedCountryInChargeGroup\":false,\r\n         \"totalGrossVolume\":0,\r\n         \"totalGrossVolumeUnit\":null,\r\n         \"commodityIntendedFor\":null,\r\n         \"animalsCertifiedAs\":null\r\n      },\r\n      \"purpose\":null,\r\n      \"pointOfEntry\":null,\r\n      \"pointOfEntryControlPoint\":null,\r\n      \"arrivalDate\":null,\r\n      \"arrivalTime\":null,\r\n      \"transporterDetailsRequired\":false,\r\n      \"transporter\":null,\r\n      \"meansOfTransport\":null,\r\n      \"meansOfTransportFromEntryPoint\":{\r\n         \"id\":null,\r\n         \"type\":null,\r\n         \"document\":null\r\n      },\r\n      \"departureDate\":null,\r\n      \"departureTime\":null,\r\n      \"estimatedJourneyTimeInMinutes\":0,\r\n      \"responsibleForTransport\":null,\r\n      \"veterinaryInformation\":null,\r\n      \"importerLocalReferenceNumber\":null,\r\n      \"sealsContainers\":null,\r\n      \"route\":null,\r\n      \"submissionDate\":null,\r\n      \"submittedBy\":null,\r\n      \"complexCommoditySelected\":false,\r\n      \"contactDetails\":null,\r\n      \"provideCtcMrn\":\"YES\"\r\n   },\r\n   \"decisionBy\":{\r\n      \"displayName\":\"Percy Inspector-Tester\",\r\n      \"userId\":\"79f6dc68-2144-e911-a96a-000d3a29ba60\"\r\n   },\r\n   \"decisionDate\":\"09/05/2024 00:00:00\",\r\n   \"partTwo\":{\r\n      \"decision\":{\r\n         \"consignmentAcceptable\":true,\r\n         \"notAcceptableAction\":null,\r\n         \"notAcceptableActionByDate\":null,\r\n         \"notAcceptableReasons\":null,\r\n         \"decision\":\"Acceptable for Internal Market\",\r\n         \"freeCirculationPurpose\":\"Animal Feeding Stuff\",\r\n         \"temporaryExitBip\":null\r\n      },\r\n      \"consignmentCheck\":{\r\n         \"euStandard\":null,\r\n         \"documentCheckResult\":\"Satisfactory\",\r\n         \"nationalRequirements\":null,\r\n         \"additionalGuarantees\":null,\r\n         \"identityCheckType\":\"Seal AlvsRequestCheck\",\r\n         \"identityCheckResult\":\"Satisfactory\",\r\n         \"identityCheckDone\":false,\r\n         \"physicalCheckDone\":false,\r\n         \"physicalCheckResult\":\"Satisfactory\",\r\n         \"welfareCheck\":null,\r\n         \"numberOfAnimalsChecked\":0\r\n      },\r\n      \"impactOfTransportOnAnimals\":null,\r\n      \"laboratoryTestsRequired\":false,\r\n      \"resealedContainersIncluded\":false,\r\n      \"resealedContainersMapping\":[\r\n         {\r\n            \"sealNumber\":\"1\",\r\n            \"containerNumber\":\"1\",\r\n            \"officialSeal\":false,\r\n            \"resealedSealNumber\":null\r\n         }\r\n      ],\r\n      \"controlAuthority\":{\r\n         \"officialVeterinarian\":{\r\n            \"firstName\":\"Percy\",\r\n            \"lastName\":\"Inspector-Tester\",\r\n            \"email\":\"DefraTestBIP@anthunt3.33mail.com\",\r\n            \"phone\":\"020 8225 7295\",\r\n            \"signed\":\"2021-12-15T02:43:30.651323\"\r\n         }\r\n      },\r\n      \"bipLocalReferenceNumber\":\"performance-local-reference\",\r\n      \"checkDate\":\"2020-11-21T21:30:00Z\",\r\n      \"accompanyingDocuments\":[\r\n         {\r\n            \"documentType\":\"veterinaryHealthCertificate\",\r\n            \"documentReference\":\"performance-doc-reference\",\r\n            \"documentIssueDate\":\"2020-12-12\",\r\n            \"attachmentId\":\"ede3b319-3ded-45d9-a705-45818d7a2a7b\",\r\n            \"attachmentFilename\":\"example.pdf\",\r\n            \"attachmentContentType\":\"application/pdf\",\r\n            \"uploadUserId\":\"79f6dc68-2144-e911-a96a-000d3a29ba60\",\r\n            \"uploadOrganisationId\":\"767ceb6a-2144-e911-a96c-000d3a29b5de\"\r\n         }\r\n      ],\r\n      \"commodityChecks\":null,\r\n      \"inspectionRequired\":\"Required\"\r\n   },\r\n   \"partThree\":{\r\n      \"control\":{\r\n         \"feedbackInformation\":{\r\n            \"authorityType\":\"finalbip\",\r\n            \"consignmentArrival\":true,\r\n            \"consignmentConformity\":true\r\n         },\r\n         \"detailsOnReExport\":{\r\n            \"date\":null,\r\n            \"meansOfTransportNo\":null,\r\n            \"transportType\":null,\r\n            \"document\":null,\r\n            \"countryOfReDispatching\":null,\r\n            \"exitBIP\":null\r\n         },\r\n         \"officialInspector\":{\r\n            \"firstName\":\"Percy\",\r\n            \"lastName\":\"Inspector-Tester\",\r\n            \"address\":{\r\n               \"street\":\"Animal and Plant Health Agency, New Haw, Woodham Lane\",\r\n               \"city\":\"Addlestone\",\r\n               \"country\":\"GB\",\r\n               \"postalCode\":\"KT15 3NB\"\r\n            },\r\n            \"signed\":\"2021-12-15T02:43:34.710339\"\r\n         },\r\n         \"consignmentLeave\":\"NO\"\r\n      },\r\n      \"controlStatus\":\"COMPLETED\"\r\n   },\r\n   \"etag\":\"000000000173D8DD\",\r\n   \"riskDecisionLockingTime\":\"2024-10-04\"\r\n}";
        var n = IpaffsNotificationExtensions.FromBlob(s);


       

    }

    [Fact]
    public void SndExample_ShouldDeserialise()
    {
      }
}
